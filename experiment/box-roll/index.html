<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <title>Box Roll</title>
  <style>
  * {
    margin:0px;
    padding:0px;
  }
  html, body {
    background-color: #000;
    color: #fff;
  }
  div, canvas {
    display:block;
  }
  canvas {
    border-bottom: 1px solid white;
  }
  </style>
  <script type="text/javascript" src="../../javascripts/modeset/math_util.js"></script>
  <script type="text/javascript" src="../../javascripts/modeset/canvas_util.js"></script>
  <script type="text/javascript" src="../../javascripts/vendor/request-animation-frame.js"></script>
  <script type="text/javascript" src="../../javascripts/modeset/elastic-point-3.js"></script>
</head>

<body>
  <canvas id="draw" width="800" height="500"></canvas>
  <div id="fps"></div>
  <script>

    var _canvas = document.getElementById("draw");
    var _context = _canvas.getContext("2d");
    var _contextSource = null;
    var _width = _canvas.width;
    var _height = _canvas.height;

    var diameter = 100;
    var radius = diameter / 2;
    var circumference = Math.PI * diameter;
    var speed = 3;
    var boxX = 0;
    var ballX = _width / 2;
    var ballY = 450;
    var boxY = 475;
    var boxSize = radius;
    var boxDiag = Math.sqrt(2) * (boxSize);
    var yTravel = boxDiag - boxSize/2;

    var gradient = _context.createLinearGradient(0, 0, radius, radius);
    gradient.addColorStop(0, '#8ED6FF');   
    // gradient.addColorStop(0.25, '#8ED6FF');   
    // gradient.addColorStop(0.5, '#004CB3');
    gradient.addColorStop(1, '#004CB3');

    _context.strokeStyle = 'rgba(0,0,0,0)';

    var _frameLength = 20;
    var _lastFrame = 0;
    var _fps = document.getElementById('fps');

    // mouse tracking
    _canvas.addEventListener('mousemove',onMouseMoved,false);
    var _mouseX = 0;
    var _mouseY = 0;
    function onMouseMoved(e){
      _mouseX = e.clientX;
      _mouseY = e.clientY;

      var roundedBoxX = _mouseX - ( _mouseX % (circumference/4) )
      _mousePos.setTarget(roundedBoxX, _mouseY, 0);
    }

    var _mousePos = new ElasticPoint( 0, 0, 0, 0.2, 0.3 );

    var render = function() {
      if(Date.now() - _lastFrame > _frameLength) {
        _fps.innerHTML = Math.round( 1000 / (Date.now() - _lastFrame) ) + 'fps';
        _lastFrame = Date.now()

        _mousePos.update();


        boxX += 2;
        ballX += 2;
        if( boxX > _width + radius ) boxX = -radius;
        if( ballX > _width + radius ) ballX = -radius;

        boxX = _mousePos.x(); //_mouseX;

        _context.clearRect(0,0,_width,_height);
        _context.fillStyle = gradient;

        // draw ball
        _context.save();
        _context.translate( ballX, ballY );
        var rotations = ballX / circumference;
        _context.rotate( MathUtil.degreesToRadians( rotations * 360 ) );
        CanvasUtil.drawCircle( _context, 0, 0, radius );
        _context.restore();

        // draw box
        _context.save();
        var rotations = boxX / circumference;
        var rotationProgress = (rotations % 0.25)/0.25; // percent of progress through quarter rotation
        var yAdd = Math.sin(rotationProgress * Math.PI) * yTravel/4;
        _context.translate( boxX, boxY - yAdd );
        _context.rotate( MathUtil.degreesToRadians( rotations * 360 ) );
        _context.fillRect( -boxSize/2, -boxSize/2, boxSize, boxSize );  
        _context.restore();

      }
      requestAnimationFrame(render);
    };
    requestAnimationFrame(render);

    var saw = function( rads ) {
      rads += Math.PI / 2;                 // add to sync up with sin(0)
      var percent = ( rads % Math.PI ) / Math.PI;       
      var dir = ( rads % (Math.PI * 2) > Math.PI ) ? -1 : 1;
      percent *= 2 * dir;
      percent -= dir;
      return percent;
    };

    // time-based animation
    // var BACKGROUND_VELOCITY = 42, // pixels / second
    //     bgVelocity = BACKGROUND_VELOCITY;

    // function setBackgroundOffset() {
    //    var offset = backgroundOffset + bgVelocity/fps; // Time-based motion

    //    if (offset > 0 && offset < background.width) {
    //       backgroundOffset = offset;
    //    }
    //    else {
    //       backgroundOffset = 0;
    //    }
    // }

  // If the radius is r, the outer rectangle size will be r*2.
  // The inner rectangle will have size equals to 2*sqrt(2*r).
  // So the diff will be equals to 2*(r-sqrt(2*r^2)).
  </script>
</body>
</html>
