<html>
  <head>
    <title>AV Loop</title>
    <meta property="og:site_name" content="HTML Experiments by CacheFlowe"/>
    <meta property="og:title" content="AV Loop"/>
    <style>
      html, body {
        background: #000;
        margin: 0px;
        padding: 0px;
        overflow: hidden;
        text-align: center;
      }
      canvas {
        background: black;
        max-width: 100%;
      }
      #debug {
        color: white;
        text-align: left;
        position: absolute;
        top: 0;
        left: 0;
      }
    </style>
  </head>
  <body>
    <div id="debug"></div>
    <!-- <audio src="my-recording-2-loop-normalized.wav" loop autoplay></video> -->
    <!-- <video src="render-2015-11-10-08-46-20-with-sound.mov" loop autoplay></video> -->
    <canvas id="draw-canvas" width="400" height="400"></canvas>
    <script>
      var debug = document.getElementById('debug');
      var startTime = 0;
      var audioTimeOffset = 0.1; // helps with the visual timing
      var ticks = 64;
      var tickTime = 0;
      var curTick = 0;
      var lastTick = 0;

      // perfect webaudio looping from: http://stackoverflow.com/questions/29882907/how-to-seamlessly-loop-sound-with-web-audio-api
      var url = 'my-recording-2-loop-normalized.wav';
      // var url = 'data:audio/wav;base64,';
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      var context = new AudioContext();
      var source = context.createBufferSource();
      source.connect(context.destination);

      var request = new XMLHttpRequest();
      request.open('GET', url, true);
      request.responseType = 'arraybuffer';
      request.onload = function() {
        context.decodeAudioData(request.response, function(response) {
          source.buffer = response;
          console.log('playing:');
          console.log('source.buffer.duration', source.buffer.duration);
          console.log('context.currentTime', context.currentTime);
        }, function () { console.error('The request failed.'); } );
      }
      request.send();

      function playAudio(){
        source.start(0);
        source.loop = true;
        startTime = context.currentTime;
        tickTime = source.buffer.duration / ticks;
        requestAnimationFrame(animate);
      }
      document.addEventListener('touchend', playAudio);
      document.addEventListener('mouseup', playAudio);

      // setup draw canvas
      var canvasDraw = document.getElementById('draw-canvas');
      canvasDraw.width = window.innerWidth;
      canvasDraw.height = window.innerHeight;
      var ctx = canvasDraw.getContext('2d');

      // stupid simple particle object
      function Particle() {
        var _x = 0,
            _y = 0,
            _xLast = 0,
            _yLast = 0,
            _size = 0,
            _color = '',
            _rads = 0;
        return {
          reset: function(x, y, size, color){
            _x = x;
            _y = y;
            _xLast = x;
            _yLast = y;
            _size = size;
            _color = color;
            _rads = Math.PI/2; // Math.PI/4 * Math.floor(Math.random() * 8)

            ctx.strokeStyle = _color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            size = size * 7;
            // ctx.arc(_x, _y, size, 0, 2*Math.PI);
            ctx.rect(_x - size/2, _y - size/2, size, size);
            ctx.stroke();

          },
          active: function(){
            return _size > 0.001;
          },
          update: function(){
            _size *= 0.999;
            _x += Math.sin(_rads) * 10;
            _y += Math.cos(_rads) * 10;
            if(_x < 0) _x = ctx.canvas.width;
            if(_x > ctx.canvas.width) _x = 0;
            if(_y < 0) _x = ctx.canvas.height;
            if(_y > ctx.canvas.height) _y = 0;
            if(Math.abs(_xLast - _x) < 50 && Math.abs(_yLast - _y) < 50) {
              ctx.strokeStyle = _color;
              ctx.lineWidth = _size;
              ctx.beginPath();
              ctx.moveTo(_xLast, _yLast);
              ctx.lineTo(_x, _y);
              ctx.stroke();
            }
            _xLast = _x;
            _yLast = _y;
          },
          beat: function() {
            if(Math.random() > 0.75) {
              _rads += (Math.random() > 0.5) ? Math.PI/4 : Math.PI/-4; // Math.PI/4 * Math.floor(Math.random() * 8)
            }
          }
        };
      }
      var particles = [];


      function newParticle(newX, newY, color) {
        var foundParticle = false;
        for(var i=0; i < particles.length; i++) {
          if(particles[i].active() == false) {
            foundParticle = true;
            return particles[i];
            break;
          }
        }
        if(foundParticle == false) {
          var newParticle = new Particle();
          particles.push(newParticle);
          return newParticle;
        }
      }


      function animate() {
        requestAnimationFrame(animate);
        if(source.buffer) {
          // calculate audio timing
          var playbackTime = (context.currentTime - startTime) % source.buffer.duration + audioTimeOffset;
          curTick = Math.floor(playbackTime / tickTime) % ticks;
          debug.innerHTML =
            'context.currentTime = ' + playbackTime + '<br>' +
            'tick = ' + curTick;


          // draw fading overlay
          ctx.beginPath();
          ctx.fillStyle = "rgba(0,0,0,0.05)";
          ctx.rect(0, 0, canvasDraw.width, canvasDraw.height);
          ctx.fill();

          // update active particles
          for(var i=0; i < particles.length; i++) {
            if(particles[i].active() == true) {
              particles[i].update();
            }
          }

          // find a dead particle, or add a new one
          var newX = ((ctx.canvas.width / ticks) * (curTick * 2)) % ctx.canvas.width;

          if(curTick != lastTick) {
            // turn on the beat
            for(var i=0; i < particles.length; i++) {
              if(particles[i].active() == true) {
                if(curTick % 4 == 2 || curTick % 8 == 4) {
                  particles[i].beat();
                }
              }
            }

            // random particles
            // newParticle().reset(newX, ctx.canvas.height * Math.random(), 2, 'rgba(255,255,255,0.3)');
            // hats
            if(curTick % 4 == 2) {
              newParticle().reset(newX, ctx.canvas.height * 0.2, 10, 'rgba(255,255,255,1)');
            }
            // smashes
            if(curTick <= 5) {
              newParticle().reset(newX, ctx.canvas.height * 0.6, 10, 'rgba(100,200,150,1)');
            }
            // snare
            if(curTick % 8 == 4) {
              // full flash
              ctx.beginPath();
              ctx.fillStyle = "rgba(255,255,255,0.2)";
              ctx.rect(0, 0, canvasDraw.width, canvasDraw.height);
              ctx.fill();
              // line
              newParticle().reset(newX, ctx.canvas.height * 0.4, 10, 'rgba(190,200,250,1)');
            }
            // kick
            if(curTick % 32 == 0 || curTick % 32 == 5 || curTick % 32 == 7 || curTick % 32 == 8 || curTick % 32 == 21 || curTick % 32 == 23) {  // repeats for both measures, hence % 32 for 64 ticks
              // full flash
              ctx.beginPath();
              ctx.fillStyle = "rgba(0,0,0,0.3)";
              ctx.rect(0, 0, canvasDraw.width, canvasDraw.height);
              ctx.fill();
              // line
              newParticle().reset(newX, ctx.canvas.height * 0.8, 10, 'rgba(190,200,250,1)');
            }
          }

          lastTick = curTick;
        }
      }
    </script>
  </body>
</html>
